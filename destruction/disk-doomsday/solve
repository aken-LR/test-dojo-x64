#!/opt/pwn.college/python

import errno
import sys
import os
import subprocess 

MARKER = "/tmp/disk_doomsday_phase1"
TEST_FILE = "/home/hacker/.space_test" 
TEST_SIZE = 1 * 1024 * 1024 # 1MB

def check_space_by_writing():
    try:
        # 尝试创建一个非常小的临时文件
        with open(TEST_FILE, "w") as f:
            f.write("test")
        os.remove(TEST_FILE)
        return True 
    except IOError as e:
        if e.errno == errno.ENOSPC:
            return False 
        else:
            print(f"检查磁盘空间时发生意外的 IO 错误: {e}")
            sys.exit(1)
    except Exception as e:
        print(f"检查磁盘空间时发生未知错误: {e}")
        sys.exit(1)

can_create = check_space_by_writing()

if not os.path.exists(MARKER):
    if can_create:
        print(
            "空间还很充足。请填满 /home/hacker 目录，直到无法创建 1MB 的文件，然后再次运行本检查程序。"
        )
    else:
        try:
            open(MARKER, "w").close()
        except IOError:
            pass
        print(
            "干得漂亮，你成功塞满了磁盘。现在请释放空间（删除你创建的文件），然后再次运行 /challenge/solve 来证明你已经清理干净了！"
        )
elif not can_create:
    print("仍然没有足够的空间。请继续清理，然后重试！")
else:
    print("磁盘空间已恢复。这是你的 flag：")
    try:
        print(open("/flag").read().strip())
    except PermissionError:
        print("错误：无法读取 /flag 文件，请检查权限。")
    except FileNotFoundError:
        print("错误：/flag 文件未找到。")
